name: Check Claude Code News

on:
  schedule:
    # æ¯Žæ—¥ UTC 09:00 (JST 18:00) ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run news check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: bash scripts/check-news.sh

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet && git diff --cached --quiet && echo "changed=false" >> "$GITHUB_OUTPUT" || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create branch, commit, and open PR
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="news/$(date -u +%Y-%m-%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add data/processed.json docs/
          git commit -m "$(cat <<'EOF'
          auto: update news articles and processed state

          Generated by Claude Code News & Deep Dive automation
          EOF
          )"
          git push -u origin "$BRANCH_NAME"

          # è¿½åŠ ã•ã‚ŒãŸè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€è¦§åŒ–
          ARTICLES=$(git diff --name-only main -- docs/ | sed 's/^/- /')
          if [ -z "$ARTICLES" ]; then
            ARTICLES="- (è¨˜äº‹ãªã— / processed.json ã®æ›´æ–°ã®ã¿)"
          fi

          gh pr create \
            --title "auto: Claude Code ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–° $(date -u +%Y-%m-%d)" \
            --body "$(cat <<EOF
          ## æ¦‚è¦

          Claude Code News & Deep Dive ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šã€æ–°ã—ã„è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

          ## è¿½åŠ ã•ã‚ŒãŸè¨˜äº‹

          ${ARTICLES}

          ## ç¢ºèªäº‹é …

          - [ ] è¨˜äº‹ã®å†…å®¹ãŒæ­£ç¢ºã‹ç¢ºèª
          - [ ] æ—¥æœ¬èªžã®è¡¨ç¾ã«å•é¡ŒãŒãªã„ã‹ç¢ºèª

          ---
          ðŸ¤– Generated by [Claude Code News & Deep Dive](https://github.com/${{ github.repository }}) automation
          EOF
          )"
