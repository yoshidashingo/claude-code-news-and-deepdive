---
title: "Claude Code v2.1.50 リリース — 大規模なメモリリーク修正とワークツリー分離機能の強化"
date: 2026-02-24
source: github-release
source_url: "https://github.com/anthropics/claude-code/releases/tag/v2.1.50"
identifier: "v2.1.50"
---

# Claude Code v2.1.50 リリース — 大規模なメモリリーク修正とワークツリー分離機能の強化

## 概要

Claude Code v2.1.50 は、長時間セッションでのメモリリークを複数箇所で修正した安定性強化リリースです。エージェントのワークツリー分離機能が大幅に拡張され、新たに `WorktreeCreate`/`WorktreeRemove` フックイベントや `isolation: worktree` のエージェント定義サポートが追加されました。また、Opus 4.6（fast mode）が完全な 1M コンテキストウィンドウに対応し、パフォーマンス面でも大きな改善が加えられています。

## 新機能

### ワークツリー分離機能の強化

エージェントがワークツリーを使った分離実行を行う際の制御が大幅に強化されました。

**`WorktreeCreate` / `WorktreeRemove` フックイベント**

エージェントワークツリー分離が worktree を作成・削除するタイミングで、カスタムの VCS セットアップとティアダウンを実行できるようになりました。たとえば、worktree 作成時に特定の設定ファイルをコピーしたり、削除時にクリーンアップスクリプトを走らせる、といった用途に利用できます。

```json
{
  "hooks": {
    "WorktreeCreate": [
      { "command": "cp .env.template .env" }
    ],
    "WorktreeRemove": [
      { "command": "cleanup.sh" }
    ]
  }
}
```

**エージェント定義での `isolation: worktree` サポート**

エージェント定義ファイルで `isolation: worktree` を宣言することで、そのエージェントを常に分離された git worktree 上で実行させることができます。これにより、エージェントがメインのリポジトリに意図しない変更を加えるリスクを低減できます。

### LSP サーバーの `startupTimeout` 設定

LSP（Language Server Protocol）サーバーの起動タイムアウトを設定できるようになりました。起動に時間のかかる Language Server を使用している場合に、タイムアウトによる接続失敗を防ぐことができます。

### `claude agents` CLI コマンド

`claude agents` コマンドが新たに追加され、現在設定されているエージェントの一覧を表示できるようになりました。どのカスタムエージェントが利用可能かをすぐに確認できます。

### `CLAUDE_CODE_SIMPLE` モードの機能拡張

`CLAUDE_CODE_SIMPLE` 環境変数が設定されている場合、これまでの skills、セッションメモリ、カスタムエージェント、CLAUDE.md のトークンカウント無効化に加えて、以下も無効化されるようになりました。

- MCP ツール
- アタッチメント
- フック
- CLAUDE.md ファイルの読み込み

最小限の環境で Claude Code を動作させたい場合に、より徹底した簡略化が可能です。

### `CLAUDE_CODE_DISABLE_1M_CONTEXT` 環境変数

1M コンテキストウィンドウのサポートを無効化するための環境変数 `CLAUDE_CODE_DISABLE_1M_CONTEXT` が追加されました。特定の環境や運用要件で大きなコンテキストウィンドウを使いたくない場合に役立ちます。

### Opus 4.6（fast mode）が 1M コンテキストウィンドウに完全対応

Opus 4.6 の fast mode が完全な 1M コンテキストウィンドウをサポートするようになりました。大規模なコードベースや長いセッションでより多くのコンテキストを保持できます。

### VSCode: `/extra-usage` コマンドのサポート

VS Code セッション内で `/extra-usage` コマンドが使えるようになりました。

## 改善点

### ヘッドレスモードの起動パフォーマンス向上

`-p` フラグを使ったヘッドレスモードで、Yoga WASM と UI コンポーネントのインポートを遅延させることで起動パフォーマンスが改善されました。CI/CD パイプラインなどでヘッドレス実行している環境では恩恵を受けやすい改善です。

### 長時間セッションのメモリ使用量改善

- コンパクション後に内部キャッシュをクリアすることでメモリ使用量を削減
- 処理済みの大きなツール結果をクリアしてメモリ効率を向上
- ファイル履歴スナップショットに上限を設け、無制限なメモリ増加を防止

## バグ修正

### セッション・ストレージ関連

**シンボリックリンクを含む作業ディレクトリでの再開セッション不可視問題**

作業ディレクトリにシンボリックリンクが含まれる場合、起動時のタイミングによってセッションストレージのパスが異なって解決されてしまい、再開したセッションが見えなくなる問題を修正しました。

**SSH 切断時のセッションデータ損失**

グレースフルシャットダウンのシーケンスにおいて、フックとアナリティクスの前にセッションデータをフラッシュするよう修正し、SSH 切断時にセッションデータが失われる問題を解消しました。

### メモリリーク修正

今回のリリースでは特に多くのメモリリーク修正が含まれています。

- **エージェントチーム**: 完了したチームメイトのタスクがセッション状態からガベージコレクトされない問題を修正
- **AppState**: 完了したタスク状態オブジェクトが AppState から削除されない問題を修正
- **LSP 診断データ**: 配信後にクリーンアップされず、長時間セッションでメモリが無制限に増加する問題を修正
- **完了タスクの出力**: 完了後もメモリに残り続ける問題を修正
- **TaskOutput**: クリーンアップ後も最近の行データが保持される問題を修正
- **CircularBuffer**: クリアしたアイテムがバッキング配列に残り続ける問題を修正
- **シェルコマンド実行**: クリーンアップ後も ChildProcess と AbortController の参照が保持される問題を修正

### Linux: glibc 2.30 未満でのネイティブモジュール読み込み失敗

glibc が 2.30 より古いシステム（RHEL 8 など）でネイティブモジュールが読み込めなかった問題を修正しました。エンタープライズ環境での利用が改善されます。

### MCP 関連

- `/mcp reconnect` コマンドで存在しないサーバー名を指定した場合に CLI がフリーズする問題を修正
- ツール検索が有効でプロンプトが起動引数として渡された場合に MCP ツールが検出されない問題を修正

### プロンプト提案キャッシュの回帰修正

プロンプト提案キャッシュのヒット率が低下していた回帰問題を修正しました。

## 技術的なポイント

- **メモリ管理の総点検**: 今回のリリースでは 8 件以上のメモリリークが修正されており、長時間セッションや多数のタスクを並行処理するエージェント運用において安定性が大幅に向上します
- **ワークツリー分離の成熟**: `isolation: worktree`、`WorktreeCreate`/`WorktreeRemove` フックが揃い、エージェントの安全な並列実行基盤がより完全な形になってきています
- **`CLAUDE_CODE_SIMPLE` の徹底した簡略化**: トークンコストや起動時間を最小化したい CI/CD 用途などで、よりクリーンな実行環境を構築できます
- **Linux エンタープライズ対応**: RHEL 8 などの古い glibc 環境でも動作するよう改善され、エンタープライズでの採用障壁が下がりました
- **1M コンテキストの扱い**: `CLAUDE_CODE_DISABLE_1M_CONTEXT` によって大きなコンテキストウィンドウを意図的に制限できる手段が提供されました

## まとめ

v2.1.50 は、多数のメモリリーク修正を中心とした信頼性・安定性の強化リリースです。長時間セッションや複数エージェントを並行稼働させている環境では特に恩恵が大きいでしょう。また、ワークツリー分離機能がエージェント定義レベルで宣言的に使えるようになり、マルチエージェントのオーケストレーション構成が一段と整備されてきています。Opus 4.6 fast mode での 1M コンテキスト対応と合わせて、大規模な開発タスクへの活用がさらに広がりそうです。
