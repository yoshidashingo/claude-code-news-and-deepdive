---
title: "Claude Code v2.1.50 リリース — メモリリーク大規模修正とエージェント worktree 分離のサポート"
date: 2026-02-22
source: github-release
source_url: "https://github.com/anthropics/claude-code/releases/tag/v2.1.50"
identifier: "v2.1.50"
---

# Claude Code v2.1.50 リリース — メモリリーク大規模修正とエージェント worktree 分離のサポート

## 概要

Claude Code v2.1.50 は、長時間セッションで顕在化していた複数のメモリリークを一挙に修正した品質改善リリースです。あわせて、エージェント定義での `isolation: worktree` サポートや `WorktreeCreate`/`WorktreeRemove` フックイベントの追加など、エージェント機能の強化も図られています。Opus 4.6 のファストモードが 1M コンテキストウィンドウに対応したことも注目ポイントです。

## 新機能

### エージェント worktree 分離のサポート

エージェント定義に `isolation: worktree` を指定できるようになりました。これにより、エージェントが宣言的に分離された git worktree 上で動作します。マルチエージェント構成における副作用の抑制や並列作業の安全性向上に役立ちます。

```yaml
# エージェント定義の例
isolation: worktree
```

### WorktreeCreate / WorktreeRemove フックイベント

エージェントが worktree を作成・削除するタイミングにフックできる `WorktreeCreate` と `WorktreeRemove` イベントが追加されました。これらを使ってカスタム VCS (バージョン管理システム) のセットアップや後処理を自動化できます。

### `claude agents` CLI コマンド

```bash
claude agents
```

設定済みのすべてのエージェントを一覧表示する新しい CLI コマンドです。利用可能なエージェントをすばやく確認できます。

### LSP サーバーの `startupTimeout` 設定

LSP (Language Server Protocol) サーバーの起動タイムアウトをカスタマイズできる `startupTimeout` 設定が追加されました。起動が遅い LSP サーバーを使用している環境での接続エラーを回避できます。

### `CLAUDE_CODE_DISABLE_1M_CONTEXT` 環境変数

1M コンテキストウィンドウサポートを無効化する環境変数が追加されました。メモリやコストを抑えたい場合に有用です。

### Opus 4.6 ファストモードの 1M コンテキスト対応

Opus 4.6 のファストモードがフル 1M コンテキストウィンドウをサポートするようになりました。大規模なコードベースや長い会話履歴を扱う際のパフォーマンスが向上します。

### VSCode: `/extra-usage` コマンドサポート

VS Code セッションで `/extra-usage` コマンドが使用できるようになりました。

## 改善点

### `CLAUDE_CODE_SIMPLE` モードの強化

`CLAUDE_CODE_SIMPLE` モードがより完全なミニマル体験を提供するようになりました。スキル、セッションメモリ、カスタムエージェント、CLAUDE.md のトークンカウントに加えて、MCP ツール、添付ファイル、フック、CLAUDE.md ファイルの読み込みもすべて無効化されます。

### ヘッドレスモードの起動パフォーマンス向上

`-p` フラグによるヘッドレスモード起動時に、Yoga WASM と UI コンポーネントのインポートを遅延させることで起動速度を改善しました。

### 長時間セッションのメモリ使用量改善

コンパクション後に内部キャッシュをクリアする処理、および処理済みの大きなツール結果を解放する処理が追加されました。長時間稼働するセッションでのメモリ使用量が抑制されます。

## バグ修正

### セッション関連

- **シンボリックリンク経由のセッション不可視バグ**: 作業ディレクトリにシンボリックリンクが含まれる場合、起動時の異なるタイミングでセッションストレージパスが解決されることにより、再開セッションが見えなくなるバグを修正しました。
- **SSH 切断時のデータ損失**: グレースフルシャットダウンシーケンスにおいて、フックやアナリティクスより前にセッションデータをフラッシュするよう修正し、SSH 接続切断時のデータ損失を防ぎます。

### Linux 互換性

glibc 2.30 より古いシステム (RHEL 8 など) でネイティブモジュールが読み込めない問題を修正しました。

### MCP 関連

- ツール検索が有効かつ起動引数としてプロンプトが渡された場合に MCP ツールが検出されないバグを修正しました。
- `/mcp reconnect` コマンドに存在しないサーバー名を渡すと CLI がフリーズするバグを修正しました。

### プロンプト提案キャッシュ

キャッシュヒット率が低下していたリグレッションを修正しました。

### メモリリーク（複数箇所）

本リリースは多数のメモリリーク修正を含みます。

- **エージェントチーム**: 完了済みのチームメイトタスクがセッション状態からガベージコレクションされない問題
- **AppState**: 完了済みタスクの状態オブジェクトが削除されない問題
- **LSP 診断データ**: 配信後に診断データがクリーンアップされず、長時間セッションでメモリが無制限に増加する問題
- **タスク出力**: 完了済みタスクの出力がメモリから解放されない問題
- **TaskOutput**: クリーンアップ後も最近の行が保持される問題
- **CircularBuffer**: クリア済みアイテムがバッキング配列に残り続ける問題
- **シェルコマンド実行**: クリーンアップ後も `ChildProcess` と `AbortController` の参照が保持される問題
- **ファイル履歴スナップショット**: スナップショット数に上限を設けることで無制限なメモリ増加を防止

## 技術的なポイント

- **worktree 分離のエージェント化**: `isolation: worktree` をエージェント定義に記述するだけで分離実行が可能になりました。これはマルチエージェントワークフローの信頼性向上に直結します。
- **メモリ管理の大幅改善**: CircularBuffer、ChildProcess、LSP 診断、タスク状態など、長時間セッションで問題になりやすいコンポーネントが網羅的に修正されています。本番環境や CI での長時間実行ユースケースで恩恵を受けやすい変更です。
- **CLAUDE_CODE_SIMPLE のミニマル化徹底**: MCP・フック・CLAUDE.md 読み込みまで無効化されるようになり、シンプルモードの意図がより明確に実現されています。テストや自動化スクリプト用途で利便性が上がります。
- **Linux 互換性の向上**: RHEL 8 など glibc 2.30 未満の環境への対応により、エンタープライズ Linux 環境でのデプロイ障壁が下がります。
- **ヘッドレスモードの高速化**: Yoga WASM の遅延ロードにより、`-p` フラグを使った CI/CD パイプラインやスクリプト実行の起動オーバーヘッドが削減されます。

## まとめ

v2.1.50 は、長時間セッションや大規模エージェント構成での安定稼働を大きく前進させるリリースです。メモリリーク修正だけで 8 箇所以上に及んでおり、Claude Code を本番ワークフローや CI パイプラインに組み込んでいる開発者にとって早期のアップデートを推奨します。また、`isolation: worktree` によるエージェント worktree 分離はマルチエージェント開発の新たな基盤となる機能であり、今後のエージェント機能拡張の布石となるでしょう。
