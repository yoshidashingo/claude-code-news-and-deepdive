---
title: "Claude Code v2.1.50 リリース - メモリリーク大規模修正とエージェント Worktree 分離機能"
date: 2026-02-21
source: github-release
source_url: "https://github.com/anthropics/claude-code/releases/tag/v2.1.50"
identifier: "v2.1.50"
---

# Claude Code v2.1.50 リリース - メモリリーク大規模修正とエージェント Worktree 分離機能

## 概要

Claude Code v2.1.50 は、長時間セッションにおける複数のメモリリークを修正し、エージェントの git worktree 分離機能を強化した大型アップデートです。新機能として `WorktreeCreate` / `WorktreeRemove` フックイベントや `claude agents` CLI コマンドが追加され、Linux 互換性の改善や SSH 切断時のセッションデータ損失修正など、安定性向上も図られています。また、Opus 4.6 の fast モードで 1M コンテキストウィンドウが利用可能になりました。

## 新機能

### エージェント Worktree 分離のサポート

エージェント定義に `isolation: worktree` を宣言的に指定できるようになりました。これにより、エージェントが独立した git worktree 内で動作し、並列タスク実行時の競合を防ぎます。

```yaml
# エージェント定義例
isolation: worktree
```

### WorktreeCreate / WorktreeRemove フックイベント

エージェントが worktree を作成・削除する際に発火する新しいフックイベント `WorktreeCreate` と `WorktreeRemove` が追加されました。カスタム VCS（バージョン管理システム）のセットアップや後処理を自動化するのに活用できます。

### claude agents CLI コマンド

設定済みエージェントの一覧を表示する `claude agents` コマンドが追加されました。

```bash
claude agents
```

このコマンドにより、現在利用可能なエージェントの構成をすばやく確認できます。

### LSP サーバーの startupTimeout 設定

LSP（Language Server Protocol）サーバーの設定に `startupTimeout` オプションが追加されました。起動に時間がかかる LSP サーバーでタイムアウトエラーが発生していた場合、この設定で待機時間を調整できます。

### Opus 4.6 fast モードで 1M コンテキストウィンドウ対応

Opus 4.6 の fast モードで、最大 100 万トークンのコンテキストウィンドウが利用できるようになりました。大規模なコードベースや長大な会話履歴を扱う場面でも、情報の欠落なく処理できます。

1M コンテキストウィンドウのサポートを無効にしたい場合は、新しい環境変数で制御できます。

```bash
export CLAUDE_CODE_DISABLE_1M_CONTEXT=1
```

### CLAUDE_CODE_SIMPLE モードの強化

`CLAUDE_CODE_SIMPLE` モードがさらにシンプルになりました。スキル、セッションメモリ、カスタムエージェント、CLAUDE.md のトークンカウントに加え、MCP ツール、添付ファイル、フック、CLAUDE.md のファイル読み込みも無効化されます。最小限の動作環境が必要なケースで有効です。

### VS Code での /extra-usage コマンド対応

VS Code セッション内で `/extra-usage` コマンドが使用できるようになりました。

## 改善点

### 長時間セッションのメモリ使用量改善

長時間のセッションにおけるメモリ効率が複数の面で改善されました。

- コンパクション後に内部キャッシュをクリアするよう変更
- 処理済みの大きなツール実行結果をメモリから解放
- ファイル履歴スナップショットに上限を設け、無制限な増加を防止

### ヘッドレスモードの起動パフォーマンス向上

`-p` フラグを使用したヘッドレスモードでの起動時に、Yoga WASM と UI コンポーネントのインポートを遅延させることで、起動パフォーマンスが改善されました。CI/CD 環境や自動化スクリプトでの利用時に効果があります。

## バグ修正

### セッション管理の修正

**シンボリックリンクを含む作業ディレクトリでのセッション不可視バグ**を修正しました。セッションストレージパスが起動中の異なるタイミングで解決されていたことが原因で、再開したセッションが一覧に表示されない問題がありました。

**SSH 切断時のセッションデータ損失**も修正されました。グレースフルシャットダウンシーケンスにおいて、フックとアナリティクスの前にセッションデータをフラッシュするよう変更することで、SSH が切断された際のデータ消失が防がれます。

### Linux 互換性の修正

glibc 2.30 未満の Linux システム（例: RHEL 8）でネイティブモジュールが読み込まれない問題を修正しました。古い Linux ディストリビューションを使用している環境でも正常に動作するようになります。

### 複数のメモリリーク修正

このリリースでは、長時間稼働するセッションで問題となっていた多数のメモリリークが修正されました。

- **エージェントチームの完了タスク**: 完了したチームメイトのタスクが AppState からガベージコレクトされない問題を修正
- **LSP 診断データ**: 配信後にクリーンアップされず、長時間セッションで無制限にメモリが増加していた問題を修正
- **TaskOutput**: クリーンアップ後も直近行のデータをメモリに保持し続けていた問題を修正
- **CircularBuffer**: クリア済みアイテムがバッキング配列に残留していた問題を修正
- **シェルコマンド実行**: クリーンアップ後も `ChildProcess` と `AbortController` の参照が保持されていた問題を修正

### MCP 関連の修正

- ツール検索が有効かつプロンプトが起動引数として渡されている場合に MCP ツールが検出されないバグを修正
- 存在しないサーバー名を指定した際に `/mcp reconnect` が CLI をフリーズさせるバグを修正

### プロンプト提案キャッシュの修正

キャッシュヒット率が低下していたプロンプト提案キャッシュのリグレッションを修正しました。

## 技術的なポイント

- **Worktree 分離の宣言的サポート**: エージェント定義に `isolation: worktree` を追加するだけで、独立した git worktree 上での実行が可能になります。並列エージェント実行でのファイル競合を構造的に防ぐ設計です
- **メモリリーク修正の網羅性**: 今回のリリースでは、CircularBuffer・LSP・TaskOutput・シェル実行・エージェントチームと、幅広いコンポーネントにわたるメモリリークが一挙に修正されており、長時間稼働環境での安定性が大幅に向上します
- **フックイベントの拡張**: `WorktreeCreate` / `WorktreeRemove` フックにより、worktree ライフサイクルに合わせた任意の処理（依存関係のインストール、設定ファイルのコピーなど）を自動化できます
- **CLAUDE_CODE_DISABLE_1M_CONTEXT 環境変数**: 1M コンテキストを意図的に無効化したいユースケース（コスト制御、特定モデルとの互換性確保など）のための逃げ道として機能します
- **glibc 2.30 未満への対応**: RHEL 8 など企業環境で多用されるレガシー Linux ディストリビューションでの動作が保証されました

## まとめ

v2.1.50 は、長時間セッションの安定性とメモリ効率を重点的に改善したリリースです。複数コンポーネントにわたるメモリリークの一括修正は、エージェントを長時間稼働させる CI/CD パイプラインや自動化ワークフローにとって特に重要な改善です。また、`isolation: worktree` のエージェント定義サポートと新しいフックイベントにより、マルチエージェント構成での VCS 管理がより柔軟になりました。Opus 4.6 fast モードへの 1M コンテキスト対応も、大規模コードベースを扱う開発者にとって実用的な強化点です。
